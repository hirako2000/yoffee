"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class e extends HTMLElement{updateProp(e){var t=void 0===this[e]?this.getAttribute(e):this[e];this.props[e]=""===t||t}constructor(e){super(),this.props=this.props||{},this.state=e||{},[...this.attributes].forEach(e=>this.updateProp(e.name)),new MutationObserver(e=>e.forEach(e=>{this.updateProp(e.attributeName),this.propUpdatedCallback&&this.propUpdatedCallback(e.attributeName)})).observe(this,{attributes:!0}),this.attachShadow({mode:"open"}),this._yoffeeFragment=this.render(),this.shadowRoot.appendChild(this._yoffeeFragment)}disconnectedCallback(){this._yoffeeFragment.__removeWatchers()}connectedCallback(){}propUpdatedCallback(){}}const t=new Map;function s(o,e,s){let i=t.get(o);null==i?(i=[{onGet:e,onSet:s}],t.set(o,i),function(o,e,s){const i={},n=t=>{Object.defineProperty(o,t,{get:()=>(e&&e(t),i[t]),set(e){i[t]=e,s&&s(t,e)}})},t=Object.getOwnPropertyDescriptors(o);for(var r of Object.keys(t))"__notWatchedProp"!==r&&(i[r]=o[r],n(r));Object.setPrototypeOf(o,new Proxy(i,{get(e,t){n(t),Reflect.get(o,t)},set:(e,t,s)=>(n(t),o[t]=s,!0)}))}(o,t=>i.forEach(e=>e.onGet(t,o)),(t,s)=>i.forEach(e=>e.onSet(t,s,o)))):i.push({onGet:e,onSet:s})}const o="Text/CSS node",i="Attribute value",n="Attribute name",l="HTML tag";function r(e,t){var s;for(s of[{type:o,xpath:`.//text()[contains(., '${t}')]`},{type:i,xpath:`.//@*[contains(., '${t}')]`},{type:n,xpath:`.//@*[contains(name(), '${t}')]`},{type:l,xpath:`.//*[contains(name(), '${t}')]`}]){var r=document.evaluate(s.xpath,e,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(null!=r)return{domNode:r,searchLocation:s.type}}}function a(e,t){for(var s of t)e=e.replace(s.id,"${"+s._cb.toString()+"}");return e}function h(){return new Array(4).fill(0).map(()=>Math.random().toString(36).substr(2,9)).join("-")}function d(e,t,s){let o=e.get(t);null!=o?o.push(s):e.set(t,[s])}class u{constructor(e,t,s){this.expressions=e,this.domNode=t,this.expressionsLocation=s,this._arrayDomNodes=[],this.initialValue={[o]:()=>t.data,[i]:()=>t.value,[n]:()=>t.name}[s](),this.ownerElement=this.domNode.ownerElement}update(){this.expressionsLocation===o?this._updateTextNodeValue():this.expressionsLocation===i?this._updateAttributeNodeValue():this.expressionsLocation===n&&this._updateAttributeNodeName()}_updateTextNodeValue(){var i,n,r,e=this.expressions[0];if(!e.cached){let o=e.lastResult;if(null!=o&&!1!==o||(o=""),this._lastTextNodeValue instanceof Array&&!(o instanceof Array)){for(var t of this._arrayDomNodes)this._removeDomNode(t);this._arrayDomNodes=[]}if(o instanceof DocumentFragment&&(o=0===o.childNodes.length?"":1===o.childNodes.length?o.firstChild:[...o.childNodes]),o instanceof Array){this._lastTextNodeValue instanceof Array||(r=document.createElement("yoffee-list-location-marker"),this.domNode.replaceWith(r),this.domNode=r);let e=[],t=null,s=e=>{null==t?null==this._arrayDomNodes[0]?this.domNode.parentNode.insertBefore(e,this.domNode):this.domNode.parentNode.insertBefore(e,(this._arrayDomNodes[0].__isYoffee?this._arrayDomNodes[0].__childNodes:this._arrayDomNodes)[0]):this.domNode.parentNode.insertBefore(e,t.nextSibling),t=e.__isYoffee?e.__childNodes[e.__childNodes.length-1]:e};for(i of o)if(null!=i){var a=this._arrayDomNodes[0];if(null!=a&&(a instanceof Text?a.data:a)===("number"==typeof i?i.toString():i))e.push(a),t=a.__isYoffee?a.__childNodes[a.__childNodes.length-1]:a,this._arrayDomNodes.shift();else if(i="object"==typeof i?i:document.createTextNode(i),e.push(i),i.__isYoffee)for(var l of i.__childNodes)s(l);else{if(i instanceof Array)throw"YOFFEE: List item cannot be another list";s(i)}}for(n of this._arrayDomNodes)-1===e.indexOf(n)&&this._removeDomNode(n);this._arrayDomNodes=e}else if("object"==typeof o){if(!(o instanceof Node))throw"YOFFEE: Text value can't be a regular JS object!";this.domNode.replaceWith(o),this.domNode=o}else"object"==typeof this._lastTextNodeValue?(r=document.createTextNode(o),this.domNode.replaceWith(r),this.domNode=r):this.domNode.data!==o.toString()&&(this.domNode.data=o);this._lastTextNodeValue=o}}_removeDomNode(e){if(e.__isYoffee)for(var t of e.__childNodes)t.remove();else e.remove()}_updateAttributeNodeValue(){if(this.expressions[0].isEventHandler){if(1<this.expressions.length)throw"YOFFEE: Cant have more than one expression as event handler: "+a(this.initialValue,this.expressions);this._setEventListener()}else{var e=this.expressions[0].lastResult,t=1===this.expressions.length&&this.initialValue.length===this.expressions[0].id.length;if(!t||!1!==e&&null!=e)if(t&&["function","object"].includes(typeof e))p(this.ownerElement,this.domNode.name,e),null!=this.domNode.ownerElement&&this.domNode.ownerElement.removeAttributeNode(this.domNode);else if(t&&!0===e)this.ownerElement[this.domNode.name]=void 0,this._setDomNode("");else{this.ownerElement[this.domNode.name]=void 0;let e=this.initialValue;for(var s of this.expressions)e=e.replace(s.id,s.lastResult);this._setDomNode(e)}else this.ownerElement[this.domNode.name]=void 0,this.ownerElement.removeAttribute(this.domNode.name)}}_setDomNode(e){this.domNode.value=e,null==this.domNode.ownerElement&&this.ownerElement.setAttributeNode(this.domNode)}_updateAttributeNodeName(){var e=this.expressions[0].lastResult,t=1===this.expressions.length&&this.initialValue.length===this.expressions[0].id.length;if(this._lastAttributeMap){for(var[s,o]of this._lastAttributeMap)this.ownerElement.removeAttribute(s),c(this.ownerElement,s);this._lastAttributeMap=null}else this.ownerElement.removeAttribute(this.domNode.name);if(!t||!1!==e&&null!=e&&""!==e)if(t&&"object"==typeof e){this._lastAttributeMap=Object.entries(e);for(var[i,n]of this._lastAttributeMap)!1!==n&&null!==n&&(["function","object"].includes(typeof n)?(p(this.ownerElement,i,n),null!=this.domNode.ownerElement&&this.domNode.ownerElement.removeAttributeNode(this.domNode)):(!0===n&&(n=""),this.ownerElement.setAttribute(i,n)))}else{let e=this.initialValue;for(var r of this.expressions)e=e.replace(r.id,r.lastResult);this.ownerElement.setAttribute(e,this.domNode.value),this.domNode=this.ownerElement.getAttributeNode(e)}}_setEventListener(){let e=this.domNode.name,t=e.substring(2),s=(...e)=>{const t=this.expressions[0].lastResult(...e);return"function"==typeof t?t(...e):t};this.domNode.ownerElement.addEventListener(t,s),p(this.domNode.ownerElement,e,s),this.domNode.ownerElement.removeAttributeNode(this.domNode)}}function p(e,t,s){e[t]=s,e.updateProp?e.updateProp(t):(null==e.props&&(e.props={}),e.props[t]=s)}function c(e,t){e[t]=void 0,e.updateProp?e.updateProp(t):(null==e.props&&(e.props={}),e.props[t]=void 0)}function f(t,s){if(t.length!==s.length)return!1;for(let e=0;e<t.length;++e)if(t[e]!==s[e])return!1;return!0}const m="primitive",_="array",N="yoffee_template";class b{constructor(e){this._cb=e,this.id=h(),this.lastResult=null,this.boundNode=null,this.boundProps=new Set,this.isEventHandler=!1,this.isStatic="function"!=typeof this._cb,this.resultType=null,this.resultMetadata=null}execute(){var e;this.cached=!1,this.isEventHandler||this.isStatic?this.lastResult=this._cb:null!=(e=this._cb())&&e.createYoffeeTemplate?this.handleYoffeeTemplate(e):Array.isArray(e)?this.handleArray(e):(this.removeChildTemplateListeners(),this.lastResult=e,this.resultType=m,this.resultMetadata=null)}handleYoffeeTemplate(s){var e,t,o,i;this.resultType===N&&null==this.resultMetadata.yoffeeTemplate||(this.resultType===N&&this.resultMetadata.cacheable&&(e=this.resultMetadata.hash,t=this.resultMetadata.propsObjs,o=s.hash,i=s.propsObjs,e===o&&f(t,i))?(this.cached=!0,this.lastResult.__expressions.forEach((e,t)=>{e._cb=s.expressionCbs[t]}),this.lastResult.__updateExpressions()):(this.removeChildTemplateListeners(),this.resultType=N,this.resultMetadata=s,this.lastResult=s.createYoffeeTemplate()))}handleArray(t){if(this.resultType===_){let e=this.resultMetadata;this.lastResult=[];let i=new Map;this.resultMetadata=i;for(let o of t)if(null!=o&&o.createYoffeeTemplate){let t=!1,s=e.get(o.hash);if(null!=s&&o.cacheable){var n=s.findIndex(e=>f(e.propsObjs,o.propsObjs));if(-1!==n){let e=s.splice(n,1)[0];t=!0,this.lastResult.push(e.yoffeeTemplate),e.shouldntDelete=!0,e.yoffeeTemplate.__expressions.forEach((e,t)=>{e._cb=o.expressionCbs[t]}),e.yoffeeTemplate.__updateExpressions(),d(i,e.hash,e)}}t||(d(i,o.hash,o),n=o.createYoffeeTemplate(),this.lastResult.push(n))}else this.lastResult.push(o);for(var s of e.values())s.forEach(e=>{e.shouldntDelete||e.yoffeeTemplate.__removeWatchers()});for(var o of i.values())o.forEach(e=>{e.shouldntDelete&&(e.shouldntDelete=void 0)})}else{this.removeChildTemplateListeners(),this.lastResult=[];var e,i,r=new Map;for(e of t)null!=e&&e.createYoffeeTemplate?(i=e.createYoffeeTemplate(),this.lastResult.push(i),d(r,e.hash,e)):this.lastResult.push(e);this.resultMetadata=r}this.resultType=_}removeChildTemplateListeners(){null!=this.resultType&&(this.resultType===N?this.resultMetadata.yoffeeTemplate.__removeWatchers():this.resultType===_&&this.lastResult.filter(e=>e.__isYoffee).forEach(e=>e.__removeWatchers()))}}function E(e,t){let s=e.data.trim(),o=s.indexOf(t),i=o+t.length;return 0!==o&&e.parentNode.insertBefore(document.createTextNode(s.substring(0,o)),e),i<s.length&&e.parentNode.insertBefore(document.createTextNode(s.substring(i)),e.nextSibling),e.data=s.substring(o,i),e}function y(o,e){return e.reduce((e,t,s)=>e+t+o[s+1],o[0]).split("").reduce(function(e,t){return(e=(e<<5)-e+t.charCodeAt(0))&e},0)}let x=new Map,w=null,g=!1,v=new Set,T=null,A=(e,t)=>{g&&(e=t.__notWatchedProp+"."+e,v.has(e)||(v.add(e),T.boundProps.add(e),x.has(e)||x.set(e,new Set),x.get(e).add(T)))},Y=(e,t,s)=>{if(g)throw`YOFFEE: Setting properties is not allowed inside an expression! (${e} = ${t})`;s=s.__notWatchedProp+"."+e,e=w;w=s;s=x.get(w);null!=s&&(C([...s],!0),w=e)};const C=(e,s)=>{var t,o=g;g=!0;try{for(let t of e){t.boundProps.forEach(e=>x.get(e).delete(t));var i=new Set(v);s?v=new Set(t.__propsAccessedByFather||[]):t.__propsAccessedByFather=new Set(v);var n=T;T=t,t.execute(),T=n,v=i}}finally{g=o}for(t of new Set(e.map(e=>e.boundNode)))t.update()};function O(e,t,s){let n=document.createDocumentFragment();n.__isYoffee=!0;const h=s.map(e=>new b(e));var d,t=function(e){let t,s=document.createElement("template");if(((e=e.trim()).startsWith("<tr")||e.startsWith("<td"))&&(" "===e[3]||">"===e[3]))throw"YOFFEE: Table tag is not supported";return s.innerHTML=`<yoffee-template-container>${e}</yoffee-template-container>`,t=s.content.firstElementChild,-1<navigator.userAgent.toLowerCase().indexOf("firefox")?document.adoptNode(t):t}((d=t,h.map(e=>e.id).reduce((e,t,s)=>e+t+d[s+1],d[0])));return function(s,e){const n=new Map;for(var h of e){var d=null;if(null==(d=r(s,h.id)))throw"YOFFEE: Expression location is not valid: ${"+h._cb.toString()+"}";let{domNode:t,searchLocation:e}=d;if(e===o&&(t=E(t,h.id)),e===l)throw"YOFFEE: Calculating element name is not allowed: "+a(`<${t.localName}>`,[h]);if(e===i&&t.name.startsWith("on")&&(h.isEventHandler=!0),n.has(t)){let e=n.get(t);e.expressions.push(h),h.boundNode=e}else{d=new u([h],t,e);n.set(t,d),h.boundNode=d}}}(t,h),n.__removeWatchers=()=>{for(let t of h)t.boundProps.forEach(e=>x.get(e).delete(t)),t.removeChildTemplateListeners()},C(h),n.__childNodes=[...t.childNodes],n.__expressions=h,n.__updateExpressions=()=>C(h.filter(e=>!e.isStatic&&!e.isEventHandler)),n.append(...t.childNodes),n}exports.YoffeeElement=e,exports.createYoffeeElement=function(t,s){if(s.prototype instanceof e)customElements.define(t,s);else{if(!(s instanceof Function))throw"YOFFEE: `createYoffeeElement` second parameter must be either a YoffeeElement subclass or a function, Got "+typeof renderCb;customElements.define(t,class extends e{render(){return s(this.props,this)}propUpdatedCallback(e){super.propUpdatedCallback(),this.onPropUpdate&&this.onPropUpdate(e)}connectedCallback(){super.connectedCallback(),this.onConnect&&this.onConnect()}disconnectedCallback(){super.disconnectedCallback(),this.onDisconnect&&this.onDisconnect()}})}},exports.html=function(...i){return i.forEach(e=>{if("object"!=typeof e)throw"YOFFEE: Props object must be an object, got "+typeof propsObject;if(null==e)throw"YOFFEE: Props object can't be null";null==e.__notWatchedProp&&(e.__notWatchedProp=h(),s(e,A,Y))}),(e,...s)=>{let o=()=>O(0,e,s);if(g){let t={propsObjs:i,expressionCbs:s,hash:y(e,s),cacheable:!0};return t.createYoffeeTemplate=()=>{var e=o();return t.yoffeeTemplate=e},t}return o()}};
